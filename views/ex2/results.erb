
<% if pr[:id] %>
  <% all_info = $ex2results.get(pr[:id]).hwia %>
  <% data = all_info[:user_actions] %>

<%

x=1

%>
  <h1> Data for subject <%=pr[:id]%> </h1>  
  <h4> Random Payoff: Part <%=all_info[:random_part]%>, trial <%=all_info[:random_move]%>, payoff <%=all_info[:rand_payoff]%> </h4>
  <h5> Final random payoff: <%= all_info[:zzz] %> </h5>
  <% if all_info[:comments].present? %><h5> Comments: <%= all_info[:comments] %> </h5><% end %>
  <% [1,2].each do |part| %>
    <h2> Part <%=part%> </h2>
    <table class='table table-striped' id='part<%=part%>'>
    <thead>
      <% fields = ['move number','choice','result','estimate'] %>
      <% fields = [ 'ID', 'age', 'gender', 'trial_num', 'condition', 'problem', 'top', 'safe_right', 'choice_side', 'risk', 'payoff', 'forgone', 'rare_asked', 'p_rare_asked', 'estimation', 'estimation_score'] %>
      <% fields.each do |k| %>
        <th><%= k %></th>  
      <% end %>
    </thead>
    <tbody>
      <% 
        key = 'moves'
        key = 'moves_part2' if part == 2
      %> 
        <% data[key].to_a.each do |move_num, info| %>
          <%
            md = move_data = info[2] || {}
          %>
            <tr>              
              <td> <%=all_info['user_actions']['subject_number'] || 'missing' %> </td>
              <td> <%=all_info['user_actions']['age'] || 'missing' %> </td>
              <td> <%=all_info['user_actions']['gender'] || 'missing' %> </td>
              <td> <%=move_num.to_i+1 %> </td>
              <td> <%=md['condition'] %> </td>
              <td> <%=md['problem_num'] %> </td>
              <td> <%=md['top'] %> </td>
              <td> <%=md['safe_right'] %> </td>
              <td> <%=md['choice_side'] %> </td>
              <td> <%=md['risk'] %> </td>
              <td> <%=md['payoff'] %> </td>
              <td> <%=md['forgone'] %> </td>
              <td> <%=md['rare_asked'] %> </td>
              <td> <%=md['p_rare_asked'] %> </td>
              <td> <%=md['estimation'] %> </td>
              <td> <%=md['estimation_score'] %> </td>
            </tr>
        <% end %>
    </tbody>
    </table>
    <button onclick=tableToExcel('part<%=part%>','data','subject_<%=pr[:id]%>_part_<%=part%>.csv') class='btn btn-primary btn-raised'>Download as excel</button>
  <% end %>

<a class='btn btn-raised btn-primary' href='/ex2/results'>Back</a>
<%#= all_info %>

<% else %>
  <h1> EX2 All Results </h1>
  <% $ex2results.all.mapo('_id').each do |id| %>
  <a class='btn btn-raised btn-primary' href='/ex2/results/<%=id%>'><%=id%></a>
  <% end %>
  <div>
  <a class='btn btn-raised btn-primary' href='/ex2'>Home</a>
  <a class='btn btn-raised btn-primary' href='#' onclick='document.location.href="/ex2/all_payments"'>All Payments CSV</a>
  </div>
<% end %>


<br/>
<br/>
<br/>
<a class='btn btn-danger btn-raised' href='/ex2/delete_all' onclick='return confirm("Are you sure? This action is irreversible.")'> Delete All! Be careful, irreversible </a>